"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.levelHandler = exports.GetUserXP = exports.AddXP = exports.GetGlobalPrestigeXP = exports.GetGlobalXP = void 0;
const index_1 = require("../index");
const index_2 = require("./index");
// const complexity = require('complexity-report');
// const complexityThreshold = 5;
const ratelimit = 60000;
const filter = new Map();
const users = new Map();
function GetGlobalXP(lvl) {
    return Math.trunc((lvl - 1 + 2 * 300 * Math.pow(2, (lvl - 1) / 7)) / 4);
}
exports.GetGlobalXP = GetGlobalXP;
function GetGlobalPrestigeXP(lvl, prestige) {
    return Math.trunc((lvl - 1 + 300 * Math.pow(2, (lvl - 1) / prestige)) / 4);
}
exports.GetGlobalPrestigeXP = GetGlobalPrestigeXP;
function between(min, max) {
    return Math.floor(Math.random() * (max - min + 1) + min);
}
function AddXP(msg, userType) {
    let random = between(20, 100);
    if (userType === "PREMIUM")
        random = between(40, 180);
    return Math.trunc(random + 1 + (0.1 * msg.content.length));
}
exports.AddXP = AddXP;
async function GetUserXP(user) {
    try {
        return await index_1.prisma.leveling.findUnique({
            where: {
                userId: user
            }
        });
    }
    catch (err) {
        return (0, index_2.log)("error", "Leveling.GetUserXP", `Something went wrong when trying to recieve user data.\n ${err.stack}`);
    }
}
exports.GetUserXP = GetUserXP;
async function levelHandler(msg, levels, user) {
    // Is user on a cooldown?
    if (users.has(msg.author.id)) {
        const lastTimestamp = users.get(msg.author.id);
        const currentTimestamp = Date.now();
        if (currentTimestamp - lastTimestamp < 5000) {
            return;
        }
    }
    users.set(msg.author.id, Date.now());
    // Spam Filter
    if (filter.has(msg.author.id)) {
        const messageCount = filter.get(msg.author.id);
        if (messageCount >= 10) {
            return;
        }
        filter.set(msg.author.id, messageCount + 1);
    }
    else {
        filter.set(msg.author.id, 0);
    }
    setTimeout(() => {
        filter.set(msg.author.id, 0);
    }, ratelimit);
    // const report = complexity.text(msg.content, { ignoreCommonWords: true });
    // if (report.score < complexityThreshold) {
    //   return;
    // }
    // Give user XP
    if (users.has(msg.author.id)) {
        let currentXp = levels.currentXp;
        currentXp += AddXP(msg, user.userType);
        await index_1.prisma.leveling.update({
            where: {
                userId: msg.author.id
            },
            data: {
                currentXp: currentXp
            }
        });
    }
    else {
        await index_1.prisma.leveling.update({
            where: {
                userId: msg.author.id
            },
            data: {
                currentXp: AddXP(msg, user.userType)
            }
        });
    }
    let currentLevel;
    let LevelUpXP = GetGlobalXP(levels.level + 1);
    console.log("Hi", GetGlobalXP(levels.level + 1));
    for (let i = 1; i < levels.level; i++) {
        LevelUpXP += GetGlobalXP(i);
        console.log("Hi2", GetGlobalXP(i));
    }
    if (levels.currentXp >= LevelUpXP) {
        currentLevel = levels.level += 1;
        await index_1.prisma.leveling.update({
            where: {
                userId: msg.author.id
            },
            data: {
                level: currentLevel
            }
        });
        msg.channel.send({ content: `You just leveled up to ${currentLevel}!` });
    }
}
exports.levelHandler = levelHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGV2ZWxpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbW9kdWxlcy9sZXZlbGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxvQ0FBa0M7QUFDbEMsbUNBQThCO0FBRTlCLG1EQUFtRDtBQUNuRCxpQ0FBaUM7QUFFakMsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDO0FBQ3hCLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFDekIsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUV4QixTQUFnQixXQUFXLENBQUMsR0FBVztJQUNuQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEdBQUMsQ0FBQyxHQUFHLENBQUMsR0FBQyxHQUFHLEdBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxHQUFHLEdBQUMsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQztBQUMvRCxDQUFDO0FBRkQsa0NBRUM7QUFFRCxTQUFnQixtQkFBbUIsQ0FBQyxHQUFXLEVBQUUsUUFBZ0I7SUFDN0QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFDLENBQUMsR0FBRyxHQUFHLEdBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxHQUFHLEdBQUMsQ0FBQyxDQUFDLEdBQUMsUUFBUSxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQztBQUNwRSxDQUFDO0FBRkQsa0RBRUM7QUFFRCxTQUFTLE9BQU8sQ0FBQyxHQUFXLEVBQUUsR0FBVztJQUNyQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQTtBQUM1RCxDQUFDO0FBRUQsU0FBZ0IsS0FBSyxD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RSxPQUFPLEVBQUUsMEJBQTBCLFlBQVksR0FBRyxFQUFFLENBQUMsQ0FBQztLQUM1RTtBQUVMLENBQUM7QUEzRUQsb0NBMkVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTGV2ZWxpbmcsIFVzZXJzIH0gZnJvbSBcIkBwcmlzbWEvY2xpZW50XCI7XHJcbmltcG9ydCB7IE1lc3NhZ2UgfSBmcm9tIFwiZGlzY29yZC5qc1wiO1xyXG5pbXBvcnQgeyBwcmlzbWEgfSBmcm9tIFwiLi4vaW5kZXhcIjtcclxuaW1wb3J0IHsgbG9nIH0gZnJvbSBcIi4vaW5kZXhcIjtcclxuXHJcbi8vIGNvbnN0IGNvbXBsZXhpdHkgPSByZXF1aXJlKCdjb21wbGV4aXR5LXJlcG9ydCcpO1xyXG4vLyBjb25zdCBjb21wbGV4aXR5VGhyZXNob2xkID0gNTtcclxuXHJcbmNvbnN0IHJhdGVsaW1pdCA9IDYwMDAwO1xyXG5jb25zdCBmaWx0ZXIgPSBuZXcgTWFwKCk7XHJcbmNvbnN0IHVzZXJzID0gbmV3IE1hcCgpO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIEdldEdsb2JhbFhQKGx2bDogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIHJldHVybiBNYXRoLnRydW5jKChsdmwtMSArIDIqMzAwKk1hdGgucG93KDIsKGx2bC0xKS83KSkvNCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBHZXRHbG9iYWxQcmVzdGlnZVhQKGx2bDogbnVtYmVyLCBwcmVzdGlnZTogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIHJldHVybiBNYXRoLnRydW5jKChsdmwtMSArIDMwMCpNYXRoLnBvdygyLChsdmwtMSkvcHJlc3RpZ2UpKS80KTtcclxufVxyXG5cclxuZnVuY3Rpb24gYmV0d2VlbihtaW46IG51bWJlciwgbWF4OiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbilcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIEFkZFhQKG1zZzogTWVzc2FnZSwgdXNlclR5cGU6IHN0cmluZykge1xyXG4gICAgbGV0IHJhbmRvbSA9IGJldHdlZW4oMjAsIDEwMCk7XHJcbiAgICBpZih1c2VyVHlwZSA9PT0gXCJQUkVNSVVNXCIpIHJhbmRvbSA9IGJldHdlZW4oNDAsIDE4MCk7XHJcbiAgICByZXR1cm4gTWF0aC50cnVuYyhyYW5kb20gKyAxICsgKDAuMSAqIG1zZy5jb250ZW50Lmxlbmd0aCkpXHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBHZXRVc2VyWFAodXNlcjogc3RyaW5nKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIHJldHVybiBhd2FpdCBwcmlzbWEubGV2ZWxpbmcuZmluZFVuaXF1ZSh7XHJcbiAgICAgICAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgICAgICAgICB1c2VySWQ6IHVzZXJcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBjYXRjaChlcnI6IGFueSkge1xyXG4gICAgICAgIHJldHVybiBsb2coXCJlcnJvclwiLCBcIkxldmVsaW5nLkdldFVzZXJYUFwiLCBgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hlbiB0cnlpbmcgdG8gcmVjaWV2ZSB1c2VyIGRhdGEuXFxuICR7ZXJyLnN0YWNrfWApO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGV2ZWxIYW5kbGVyKG1zZzogTWVzc2FnZSwgbGV2ZWxzOiBMZXZlbGluZywgdXNlcjogVXNlcnMpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIC8vIElzIHVzZXIgb24gYSBjb29sZG93bj9cclxuICAgIGlmKHVzZXJzLmhhcyhtc2cuYXV0aG9yLmlkKSkge1xyXG4gICAgICAgIGNvbnN0IGxhc3RUaW1lc3RhbXAgPSB1c2Vycy5nZXQobXNnLmF1dGhvci5pZCk7XHJcbiAgICAgICAgY29uc3QgY3VycmVudFRpbWVzdGFtcCA9IERhdGUubm93KCk7XHJcbiAgICAgICAgaWYoY3VycmVudFRpbWVzdGFtcCAtIGxhc3RUaW1lc3RhbXAgPCA1MDAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB1c2Vycy5zZXQobXNnLmF1dGhvci5pZCwgRGF0ZS5ub3coKSk7XHJcblxyXG4gICAgLy8gU3BhbSBGaWx0ZXJcclxuICAgIGlmKGZpbHRlci5oYXMobXNnLmF1dGhvci5pZCkpIHtcclxuICAgICAgICBjb25zdCBtZXNzYWdlQ291bnQgPSBmaWx0ZXIuZ2V0KG1zZy5hdXRob3IuaWQpO1xyXG4gICAgICAgIGlmIChtZXNzYWdlQ291bnQgPj0gMTApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmaWx0ZXIuc2V0KG1zZy5hdXRob3IuaWQsIG1lc3NhZ2VDb3VudCArIDEpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBmaWx0ZXIuc2V0KG1zZy5hdXRob3IuaWQsIDApO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgIGZpbHRlci5zZXQobXNnLmF1dGhvci5pZCwgMCk7XHJcbiAgICB9LCByYXRlbGltaXQpO1xyXG5cclxuICAgIC8vIGNvbnN0IHJlcG9ydCA9IGNvbXBsZXhpdHkudGV4dChtc2cuY29udGVudCwgeyBpZ25vcmVDb21tb25Xb3JkczogdHJ1ZSB9KTtcclxuICAgIC8vIGlmIChyZXBvcnQuc2NvcmUgPCBjb21wbGV4aXR5VGhyZXNob2xkKSB7XHJcbiAgICAvLyAgIHJldHVybjtcclxuICAgIC8vIH1cclxuXHJcbiAgICAvLyBHaXZlIHVzZXIgWFBcclxuICAgIGlmKHVzZXJzLmhhcyhtc2cuYXV0aG9yLmlkKSkge1xyXG4gICAgICAgIGxldCBjdXJyZW50WHAgPSBsZXZlbHMuY3VycmVudFhwO1xyXG4gICAgICAgIGN1cnJlbnRYcCArPSBBZGRYUChtc2csIHVzZXIudXNlclR5cGUpXHJcbiAgICAgICAgYXdhaXQgcHJpc21hLmxldmVsaW5nLnVwZGF0ZSh7XHJcbiAgICAgICAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgICAgICAgICB1c2VySWQ6IG1zZy5hdXRob3IuaWRcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFhwOiBjdXJyZW50WHBcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgICBhd2FpdCBwcmlzbWEubGV2ZWxpbmcudXBkYXRlKHtcclxuICAgICAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgICAgICAgIHVzZXJJZDogbXNnLmF1dGhvci5pZFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICBjdXJyZW50WHA6IEFkZFhQKG1zZywgdXNlci51c2VyVHlwZSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBjdXJyZW50TGV2ZWw6IG51bWJlcjtcclxuICAgIGxldCBMZXZlbFVwWFAgPSBHZXRHbG9iYWxYUChsZXZlbHMubGV2ZWwrMSk7XHJcbiAgICBjb25zb2xlLmxvZyhcIkhpXCIsIEdldEdsb2JhbFhQKGxldmVscy5sZXZlbCsxKSlcclxuICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGV2ZWxzLmxldmVsOyBpKyspIHtcclxuICAgICAgICBMZXZlbFVwWFAgKz0gR2V0R2xvYmFsWFAoaSk7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJIaTJcIiwgR2V0R2xvYmFsWFAoaSkpXHJcbiAgICB9XHJcblxyXG4gICAgaWYobGV2ZWxzLmN1cnJlbnRYcCA+PSBMZXZlbFVwWFApIHtcclxuICAgICAgICBjdXJyZW50TGV2ZWwgPSBsZXZlbHMubGV2ZWwgKz0gMTtcclxuICAgICAgICBhd2FpdCBwcmlzbWEubGV2ZWxpbmcudXBkYXRlKHtcclxuICAgICAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgICAgICAgIHVzZXJJZDogbXNnLmF1dGhvci5pZFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICBsZXZlbDogY3VycmVudExldmVsXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBtc2cuY2hhbm5lbC5zZW5kKHsgY29udGVudDogYFlvdSBqdXN0IGxldmVsZWQgdXAgdG8gJHtjdXJyZW50TGV2ZWx9IWAgfSk7XHJcbiAgICB9XHJcblxyXG59Il19