"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.levelHandler = exports.GetUserXP = exports.AddXP = exports.GetGlobalPrestigeXP = exports.GetGlobalXP = void 0;
const index_1 = require("../index");
const index_2 = require("./index");
// const complexity = require('complexity-report');
// const complexityThreshold = 5;
const ratelimit = 60000;
const cooldown = new Map();
function GetGlobalXP(lvl) {
    return Math.trunc((lvl - 1 + 2 * 300 * Math.pow(2, (lvl - 1) / 7)) / 4);
}
exports.GetGlobalXP = GetGlobalXP;
function GetGlobalPrestigeXP(lvl, prestige) {
    return Math.trunc((lvl - 1 + 300 * Math.pow(2, (lvl - 1) / prestige)) / 4);
}
exports.GetGlobalPrestigeXP = GetGlobalPrestigeXP;
function between(min, max) {
    return Math.floor(Math.random() * (max - min + 1) + min);
}
function AddXP(msg, userType) {
    let random = between(20, 40);
    if (userType === "STAFF" || userType === "DEV")
        random = between(40, 180);
    return Math.trunc(random + 1 + (0.1 * msg.content.length));
}
exports.AddXP = AddXP;
async function GetUserXP(user) {
    try {
        return await index_1.prisma.leveling.findUnique({
            where: {
                userId: user
            }
        });
    }
    catch (err) {
        return (0, index_2.log)("error", "Leveling.GetUserXP", `Something went wrong when trying to recieve user data.\n ${err.stack}`);
    }
}
exports.GetUserXP = GetUserXP;
async function levelHandler(msg, levels, user) {
    // Cooldowns
    if (!cooldown.has(msg.author.id)) {
        cooldown.set(msg.author.id, 0);
    }
    if (cooldown.has(msg.author.id)) {
        let messageCount = cooldown.get(msg.author.id);
        console.log(messageCount);
        if (messageCount >= 4)
            return;
        cooldown.set(msg.author.id, messageCount ? messageCount + 1 : 1);
    }
    setTimeout(() => {
        cooldown.set(msg.author.id, 0);
    }, ratelimit);
    // Give user XP
    if (user) {
        let currentXp = levels.currentXp;
        currentXp += AddXP(msg, user.userType);
        await index_1.prisma.leveling.update({
            where: {
                userId: msg.author.id
            },
            data: {
                currentXp: currentXp
            }
        });
    }
    else {
        await index_1.prisma.leveling.update({
            where: {
                userId: msg.author.id
            },
            data: {
                currentXp: AddXP(msg, user.userType)
            }
        });
    }
    let currentLevel;
    let LevelUpXP = GetGlobalXP(levels.level + 1);
    for (let i = 1; i < levels.level; i++) {
        LevelUpXP += GetGlobalXP(i);
    }
    if (levels.currentXp >= LevelUpXP) {
        currentLevel = levels.level += 1;
        await index_1.prisma.leveling.update({
            where: {
                userId: msg.author.id
            },
            data: {
                level: currentLevel
            }
        });
        msg.channel.send({ content: `You just leveled up to ${currentLevel}!` });
    }
}
exports.levelHandler = levelHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGV2ZWxpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbW9kdWxlcy9sZXZlbGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxvQ0FBa0M7QUFDbEMsbUNBQThCO0FBRTlCLG1EQUFtRDtBQUNuRCxpQ0FBaUM7QUFFakMsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDO0FBQ3hCLE1BQU0sUUFBUSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFHM0IsU0FBZ0IsV0FBVyxDQUFDLEdBQVc7SUFDbkMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFDLENBQUMsR0FBRyxDQUFDLEdBQUMsR0FBRyxHQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFDLENBQUMsR0FBRyxHQUFDLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUM7QUFDL0QsQ0FBQztBQUZELGtDQUVDO0FBRUQsU0FBZ0IsbUJBQW1CLENBQUMsR0FBVyxFQUFFLFFBQWdCO0lBQzdELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFDLENBQUMsR0FBRyxHQUFDLENBQUMsQ0FBQyxHQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEUsQ0FBQztBQUZELGtEQUVDO0FBRUQsU0FBUyxPQUFPLENBQUMsR0FBVyxFQUFFLEdBQVc7SUFDckMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUE7QUFDNUQsQ0FBQztBQUVELFNBQWdCLEtBQUssQ0FBQyxHQUFZLEVBQUUsUUFBZ0I7SUFDaEQsSUFBSSxNQUFNLEdBQUcs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QyxDQUFDO0lBQzVDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ25DLFNBQVMsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDL0I7SUFFRCxJQUFHLE1BQU0sQ0FBQyxTQUFTLElBQUksU0FBUyxFQUFFO1FBQzlCLFlBQVksR0FBRyxNQUFNLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztRQUNqQyxNQUFNLGNBQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQ3pCLEtBQUssRUFBRTtnQkFDSCxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO2FBQ3hCO1lBQ0QsSUFBSSxFQUFFO2dCQUNGLEtBQUssRUFBRSxZQUFZO2FBQ3RCO1NBQ0osQ0FBQyxDQUFDO1FBQ0gsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsMEJBQTBCLFlBQVksR0FBRyxFQUFFLENBQUMsQ0FBQztLQUM1RTtBQUVMLENBQUM7QUE1REQsb0NBNERDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTGV2ZWxpbmcsIFVzZXJzIH0gZnJvbSBcIkBwcmlzbWEvY2xpZW50XCI7XHJcbmltcG9ydCB7IE1lc3NhZ2UgfSBmcm9tIFwiZGlzY29yZC5qc1wiO1xyXG5pbXBvcnQgeyBwcmlzbWEgfSBmcm9tIFwiLi4vaW5kZXhcIjtcclxuaW1wb3J0IHsgbG9nIH0gZnJvbSBcIi4vaW5kZXhcIjtcclxuXHJcbi8vIGNvbnN0IGNvbXBsZXhpdHkgPSByZXF1aXJlKCdjb21wbGV4aXR5LXJlcG9ydCcpO1xyXG4vLyBjb25zdCBjb21wbGV4aXR5VGhyZXNob2xkID0gNTtcclxuXHJcbmNvbnN0IHJhdGVsaW1pdCA9IDYwMDAwO1xyXG5jb25zdCBjb29sZG93biA9IG5ldyBNYXAoKTtcclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gR2V0R2xvYmFsWFAobHZsOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIE1hdGgudHJ1bmMoKGx2bC0xICsgMiozMDAqTWF0aC5wb3coMiwobHZsLTEpLzcpKS80KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIEdldEdsb2JhbFByZXN0aWdlWFAobHZsOiBudW1iZXIsIHByZXN0aWdlOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIE1hdGgudHJ1bmMoKGx2bC0xICsgMzAwKk1hdGgucG93KDIsKGx2bC0xKS9wcmVzdGlnZSkpLzQpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBiZXR3ZWVuKG1pbjogbnVtYmVyLCBtYXg6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpICsgbWluKVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gQWRkWFAobXNnOiBNZXNzYWdlLCB1c2VyVHlwZTogc3RyaW5nKSB7XHJcbiAgICBsZXQgcmFuZG9tID0gYmV0d2VlbigyMCwgNDApO1xyXG4gICAgaWYodXNlclR5cGUgPT09IFwiU1RBRkZcIiB8fCB1c2VyVHlwZSA9PT0gXCJERVZcIikgcmFuZG9tID0gYmV0d2Vlbig0MCwgMTgwKTtcclxuICAgIHJldHVybiBNYXRoLnRydW5jKHJhbmRvbSArIDEgKyAoMC4xICogbXNnLmNvbnRlbnQubGVuZ3RoKSlcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIEdldFVzZXJYUCh1c2VyOiBzdHJpbmcpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHByaXNtYS5sZXZlbGluZy5maW5kVW5pcXVlKHtcclxuICAgICAgICAgICAgd2hlcmU6IHtcclxuICAgICAgICAgICAgICAgIHVzZXJJZDogdXNlclxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGNhdGNoKGVycjogYW55KSB7XHJcbiAgICAgICAgcmV0dXJuIGxvZyhcImVycm9yXCIsIFwiTGV2ZWxpbmcuR2V0VXNlclhQXCIsIGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aGVuIHRyeWluZyB0byByZWNpZXZlIHVzZXIgZGF0YS5cXG4gJHtlcnIuc3RhY2t9YCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsZXZlbEhhbmRsZXIobXNnOiBNZXNzYWdlLCBsZXZlbHM6IExldmVsaW5nLCB1c2VyOiBVc2Vycyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgLy8gQ29vbGRvd25zXHJcbiAgICBpZighY29vbGRvd24uaGFzKG1zZy5hdXRob3IuaWQpKSB7XHJcbiAgICAgICAgY29vbGRvd24uc2V0KG1zZy5hdXRob3IuaWQsIDApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmKGNvb2xkb3duLmhhcyhtc2cuYXV0aG9yLmlkKSkge1xyXG4gICAgICAgIGxldCBtZXNzYWdlQ291bnQgPSBjb29sZG93bi5nZXQobXNnLmF1dGhvci5pZCk7XHJcbiAgICAgICAgY29uc29sZS5sb2cobWVzc2FnZUNvdW50KVxyXG4gICAgICAgIGlmKG1lc3NhZ2VDb3VudCA+PSA0KSByZXR1cm47XHJcbiAgICAgICAgY29vbGRvd24uc2V0KG1zZy5hdXRob3IuaWQsIG1lc3NhZ2VDb3VudCA/IG1lc3NhZ2VDb3VudCArIDEgOiAxKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICBjb29sZG93bi5zZXQobXNnLmF1dGhvci5pZCwgMCk7XHJcbiAgICB9LCByYXRlbGltaXQpO1xyXG5cclxuICAgIC8vIEdpdmUgdXNlciBYUFxyXG4gICAgaWYodXNlcikge1xyXG4gICAgICAgIGxldCBjdXJyZW50WHAgPSBsZXZlbHMuY3VycmVudFhwO1xyXG5cclxuICAgICAgICBjdXJyZW50WHAgKz0gQWRkWFAobXNnLCB1c2VyLnVzZXJUeXBlKVxyXG4gICAgICAgIGF3YWl0IHByaXNtYS5sZXZlbGluZy51cGRhdGUoe1xyXG4gICAgICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgICAgICAgdXNlcklkOiBtc2cuYXV0aG9yLmlkXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRYcDogY3VycmVudFhwXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXdhaXQgcHJpc21hLmxldmVsaW5nLnVwZGF0ZSh7XHJcbiAgICAgICAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgICAgICAgICB1c2VySWQ6IG1zZy5hdXRob3IuaWRcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFhwOiBBZGRYUChtc2csIHVzZXIudXNlclR5cGUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgY3VycmVudExldmVsOiBudW1iZXI7XHJcbiAgICBsZXQgTGV2ZWxVcFhQID0gR2V0R2xvYmFsWFAobGV2ZWxzLmxldmVsKzEpO1xyXG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZXZlbHMubGV2ZWw7IGkrKykge1xyXG4gICAgICAgIExldmVsVXBYUCArPSBHZXRHbG9iYWxYUChpKTtcclxuICAgIH1cclxuXHJcbiAgICBpZihsZXZlbHMuY3VycmVudFhwID49IExldmVsVXBYUCkge1xyXG4gICAgICAgIGN1cnJlbnRMZXZlbCA9IGxldmVscy5sZXZlbCArPSAxO1xyXG4gICAgICAgIGF3YWl0IHByaXNtYS5sZXZlbGluZy51cGRhdGUoe1xyXG4gICAgICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgICAgICAgdXNlcklkOiBtc2cuYXV0aG9yLmlkXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGxldmVsOiBjdXJyZW50TGV2ZWxcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG1zZy5jaGFubmVsLnNlbmQoeyBjb250ZW50OiBgWW91IGp1c3QgbGV2ZWxlZCB1cCB0byAke2N1cnJlbnRMZXZlbH0hYCB9KTtcclxuICAgIH1cclxuXHJcbn0iXX0=