"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.levelHandler = exports.GetUserXP = exports.AddXP = exports.GetGlobalPrestigeXP = exports.GetGlobalXP = void 0;
const index_1 = require("../index");
const logger_1 = require("#utils/logger");
const ratelimit = 60000;
const cooldown = new Map();
function GetGlobalXP(lvl) {
    return Math.trunc((lvl - 1 + 2 * 300 * Math.pow(2, (lvl - 1) / 7)) / 4);
}
exports.GetGlobalXP = GetGlobalXP;
function GetGlobalPrestigeXP(lvl, prestige) {
    return Math.trunc((lvl - 1 + 300 * Math.pow(2, (lvl - 1) / prestige)) / 4);
}
exports.GetGlobalPrestigeXP = GetGlobalPrestigeXP;
function between(min, max) {
    return Math.floor(Math.random() * (max - min + 1) + min);
}
function AddXP(msg, userType) {
    let random = between(20, 40);
    if (userType === "STAFF" || userType === "DEV")
        random = between(40, 180);
    return Math.trunc(random + 1 + (0.1 * msg.content.length));
}
exports.AddXP = AddXP;
async function GetUserXP(user) {
    try {
        return await index_1.prisma.leveling.findUnique({
            where: {
                userId: user
            }
        });
    }
    catch (err) {
        return (0, logger_1.log)("error", "Leveling.GetUserXP", `Something went wrong when trying to recieve user data.\n ${err.stack}`);
    }
}
exports.GetUserXP = GetUserXP;
async function levelHandler(msg, levels, user) {
    // Cooldowns
    if (!cooldown.has(msg.author.id)) {
        cooldown.set(msg.author.id, 0);
    }
    if (cooldown.has(msg.author.id)) {
        let messageCount = cooldown.get(msg.author.id);
        console.log(messageCount);
        if (messageCount >= 4)
            return;
        cooldown.set(msg.author.id, messageCount ? messageCount + 1 : 1);
    }
    setTimeout(() => {
        cooldown.set(msg.author.id, 0);
    }, ratelimit);
    // Give user XP
    if (user) {
        let currentXp = levels.currentXp;
        currentXp += AddXP(msg, user.userType);
        await index_1.prisma.leveling.update({
            where: {
                userId: msg.author.id
            },
            data: {
                currentXp: currentXp
            }
        });
    }
    else {
        await index_1.prisma.leveling.update({
            where: {
                userId: msg.author.id
            },
            data: {
                currentXp: AddXP(msg, user.userType)
            }
        });
    }
    let currentLevel;
    let LevelUpXp = 0;
    for (let i = 2; i < levels.level + 2; i++) {
        LevelUpXp += GetGlobalXP(i);
    }
    // Level up
    if (levels.currentXp >= LevelUpXp) {
        currentLevel = levels.level + 1;
        await index_1.prisma.leveling.update({
            where: {
                userId: msg.author.id
            },
            data: {
                level: currentLevel
            }
        });
        msg.channel.send({ content: `You just leveled up to ${currentLevel}!` });
    }
}
exports.levelHandler = levelHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGV2ZWxpbmcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbW9kdWxlcy9sZXZlbGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxvQ0FBa0M7QUFDbEMsMENBQW9DO0FBRXBDLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQztBQUN4QixNQUFNLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBRzNCLFNBQWdCLFdBQVcsQ0FBQyxHQUFXO0lBQ25DLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQzVFLENBQUM7QUFGRCxrQ0FFQztBQUVELFNBQWdCLG1CQUFtQixDQUFDLEdBQVcsRUFBRSxRQUFnQjtJQUM3RCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQy9FLENBQUM7QUFGRCxrREFFQztBQUVELFNBQVMsT0FBTyxDQUFDLEdBQVcsRUFBRSxHQUFXO0lBQ3JDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFBO0FBQzVELENBQUM7QUFFRCxTQUFnQixLQUFLLENBQUMsR0FBWSxFQUFFLFFBQWdCO0lBQ2hELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxFQUFFLEVBQUUsRUFBRSxD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QyxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3ZDLFNBQVMsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDL0I7SUFFRCxXQUFXO0lBQ1gsSUFBSSxNQUFNLENBQUMsU0FBUyxJQUFJLFNBQVMsRUFBRTtRQUMvQixZQUFZLEdBQUcsTUFBTSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDaEMsTUFBTSxjQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQztZQUN6QixLQUFLLEVBQUU7Z0JBQ0gsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRTthQUN4QjtZQUNELElBQUksRUFBRTtnQkFDRixLQUFLLEVBQUUsWUFBWTthQUN0QjtTQUNKLENBQUMsQ0FBQztRQUNILEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLDBCQUEwQixZQUFZLEdBQUcsRUFBRSxDQUFDLENBQUM7S0FDNUU7QUFDTCxDQUFDO0FBNURELG9DQTREQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExldmVsaW5nLCBVc2VycyB9IGZyb20gXCJAcHJpc21hL2NsaWVudFwiO1xyXG5pbXBvcnQgeyBNZXNzYWdlIH0gZnJvbSBcImRpc2NvcmQuanNcIjtcclxuaW1wb3J0IHsgcHJpc21hIH0gZnJvbSBcIi4uL2luZGV4XCI7XHJcbmltcG9ydCB7IGxvZyB9IGZyb20gXCIjdXRpbHMvbG9nZ2VyXCI7XHJcblxyXG5jb25zdCByYXRlbGltaXQgPSA2MDAwMDtcclxuY29uc3QgY29vbGRvd24gPSBuZXcgTWFwKCk7XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIEdldEdsb2JhbFhQKGx2bDogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIHJldHVybiBNYXRoLnRydW5jKChsdmwgLSAxICsgMiAqIDMwMCAqIE1hdGgucG93KDIsIChsdmwgLSAxKSAvIDcpKSAvIDQpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gR2V0R2xvYmFsUHJlc3RpZ2VYUChsdmw6IG51bWJlciwgcHJlc3RpZ2U6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4gTWF0aC50cnVuYygobHZsIC0gMSArIDMwMCAqIE1hdGgucG93KDIsIChsdmwgLSAxKSAvIHByZXN0aWdlKSkgLyA0KTtcclxufVxyXG5cclxuZnVuY3Rpb24gYmV0d2VlbihtaW46IG51bWJlciwgbWF4OiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbilcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIEFkZFhQKG1zZzogTWVzc2FnZSwgdXNlclR5cGU6IHN0cmluZykge1xyXG4gICAgbGV0IHJhbmRvbSA9IGJldHdlZW4oMjAsIDQwKTtcclxuICAgIGlmICh1c2VyVHlwZSA9PT0gXCJTVEFGRlwiIHx8IHVzZXJUeXBlID09PSBcIkRFVlwiKSByYW5kb20gPSBiZXR3ZWVuKDQwLCAxODApO1xyXG4gICAgcmV0dXJuIE1hdGgudHJ1bmMocmFuZG9tICsgMSArICgwLjEgKiBtc2cuY29udGVudC5sZW5ndGgpKVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gR2V0VXNlclhQKHVzZXI6IHN0cmluZykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICByZXR1cm4gYXdhaXQgcHJpc21hLmxldmVsaW5nLmZpbmRVbmlxdWUoe1xyXG4gICAgICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgICAgICAgdXNlcklkOiB1c2VyXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycjogYW55KSB7XHJcbiAgICAgICAgcmV0dXJuIGxvZyhcImVycm9yXCIsIFwiTGV2ZWxpbmcuR2V0VXNlclhQXCIsIGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aGVuIHRyeWluZyB0byByZWNpZXZlIHVzZXIgZGF0YS5cXG4gJHtlcnIuc3RhY2t9YCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsZXZlbEhhbmRsZXIobXNnOiBNZXNzYWdlLCBsZXZlbHM6IExldmVsaW5nLCB1c2VyOiBVc2Vycyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgLy8gQ29vbGRvd25zXHJcbiAgICBpZiAoIWNvb2xkb3duLmhhcyhtc2cuYXV0aG9yLmlkKSkge1xyXG4gICAgICAgIGNvb2xkb3duLnNldChtc2cuYXV0aG9yLmlkLCAwKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY29vbGRvd24uaGFzKG1zZy5hdXRob3IuaWQpKSB7XHJcbiAgICAgICAgbGV0IG1lc3NhZ2VDb3VudCA9IGNvb2xkb3duLmdldChtc2cuYXV0aG9yLmlkKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhtZXNzYWdlQ291bnQpXHJcbiAgICAgICAgaWYgKG1lc3NhZ2VDb3VudCA+PSA0KSByZXR1cm47XHJcbiAgICAgICAgY29vbGRvd24uc2V0KG1zZy5hdXRob3IuaWQsIG1lc3NhZ2VDb3VudCA/IG1lc3NhZ2VDb3VudCArIDEgOiAxKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICBjb29sZG93bi5zZXQobXNnLmF1dGhvci5pZCwgMCk7XHJcbiAgICB9LCByYXRlbGltaXQpO1xyXG5cclxuICAgIC8vIEdpdmUgdXNlciBYUFxyXG4gICAgaWYgKHVzZXIpIHsgICAgICAgIFxyXG4gICAgICAgIGxldCBjdXJyZW50WHAgPSBsZXZlbHMuY3VycmVudFhwO1xyXG5cclxuICAgICAgICBjdXJyZW50WHAgKz0gQWRkWFAobXNnLCB1c2VyLnVzZXJUeXBlKVxyXG4gICAgICAgIGF3YWl0IHByaXNtYS5sZXZlbGluZy51cGRhdGUoe1xyXG4gICAgICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgICAgICAgdXNlcklkOiBtc2cuYXV0aG9yLmlkXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRYcDogY3VycmVudFhwXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYXdhaXQgcHJpc21hLmxldmVsaW5nLnVwZGF0ZSh7XHJcbiAgICAgICAgICAgIHdoZXJlOiB7XHJcbiAgICAgICAgICAgICAgICB1c2VySWQ6IG1zZy5hdXRob3IuaWRcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFhwOiBBZGRYUChtc2csIHVzZXIudXNlclR5cGUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgY3VycmVudExldmVsOiBudW1iZXI7XHJcbiAgICBsZXQgTGV2ZWxVcFhwID0gMDtcclxuICAgIGZvciAobGV0IGkgPSAyOyBpIDwgbGV2ZWxzLmxldmVsICsgMjsgaSsrKSB7XHJcbiAgICAgICAgTGV2ZWxVcFhwICs9IEdldEdsb2JhbFhQKGkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIExldmVsIHVwXHJcbiAgICBpZiAobGV2ZWxzLmN1cnJlbnRYcCA+PSBMZXZlbFVwWHApIHtcclxuICAgICAgICBjdXJyZW50TGV2ZWwgPSBsZXZlbHMubGV2ZWwgKyAxO1xyXG4gICAgICAgIGF3YWl0IHByaXNtYS5sZXZlbGluZy51cGRhdGUoe1xyXG4gICAgICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgICAgICAgdXNlcklkOiBtc2cuYXV0aG9yLmlkXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGxldmVsOiBjdXJyZW50TGV2ZWxcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG1zZy5jaGFubmVsLnNlbmQoeyBjb250ZW50OiBgWW91IGp1c3QgbGV2ZWxlZCB1cCB0byAke2N1cnJlbnRMZXZlbH0hYCB9KTtcclxuICAgIH1cclxufSJdfQ==